<!DOCTYPE html>
<html lang="en">
	<head>
		<title>CommandOfStrategy</title>
        <meta charset="utf-8">
        <link type='text/css' rel='stylesheet' href='./main-cos.css'>
        <base href="app://./" />
               
	</head>

	<body>
        <div id="cont"></div>
        <div id="info" class="ui"><h4>[資訊]</h4>
            <p>== 天 ==</p>
                <p>時辰：卯時<br>天氣：晴朗</p><br>
            <p>== 地 ==</p>
                <p>地形：砂土</p><br>
            <p>== 人 ==</p>
                <p>職業：步卒</p><br>
            <span>
            <p><button>W</button>：前進</p>
            <p><button>D</button>：右轉</p>
            <p><button>A</button>：左轉</p>
            <p><button id='commandButton'>X</button>：攻擊</p><br>
            </span>
            <p>== 物 ==</p><p>品項：火炬</p>
        </div>
        <div id="dial" class="ui"><h4>[對話]</h4>
            <p>主帥：對戰開始</p>
            <p style="position:absolute; bottom:0px; width:100%; font-weight:bold;">
                指令:<input type="text" onkeypress="" id='commandLine'>
                <button>Enter</button>
            </p>
        </div>
        <!-- <script src="https://code.jquery.com/jquery-3.4.1.js"></script>  -->
		<script type="module">
            // three.js module
			import * as THREE from './COS.js/three.js/three.module.js';
			import { MTLLoader } from './COS.js/three.js/MTLLoader.js';
			import { OBJLoader } from './COS.js/three.js/OBJLoader.js';
            import { BVHLoader } from './COS.js/three.js/BVHLoader.js';
            // COS.js module
            import { Character } from './COS.js/Character.js';
            import { Accessory } from './COS.js/Accessory.js';
            import { EmptyMap,BuildField } from './COS.js/BattleField.js';
            // import config from './test.js'
            // console.log(config)

			var container;
			var camera, scene, renderer;
            var clock = new THREE.Clock();
            var peoples=[],things=[],selectors=[]
            var map,field
            var commandLine=document.getElementById("commandLine")
            var focusMan,focusObj
            var fs=require('fs')
            // console.log(fs)
            

            document.getElementById("commandButton").addEventListener(
                'click',function(){
                    console.log(this.innerHTML)
                    commandLine.value+=this.innerHTML
                }
            )            

			function init() {
                // renderer
                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth*.8, window.innerHeight*.7);
                container = document.getElementById( 'cont' );
                document.body.appendChild( container );
                container.appendChild( renderer.domElement );

				// scene
                scene = new THREE.Scene();

                // camera
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight,0.1, 2000 );
                camera.position.set(10,20,-20)
                camera.rotateY(-Math.PI)
                camera.rotateX(-2*Math.PI/8)
                scene.add( camera );
                
                // lights
				var ambientLight = new THREE.AmbientLight( 0xcccccc, 1);
				scene.add( ambientLight );
                
				// var pointLight = new THREE.PointLight( 0xffffff, .3 );
                // scene.add( pointLight );
                // pointLight.position.set(5,5,5)

                // try fs load json --------------
                var compaign
                // fs.readFile('compaign_data.json',function(err,data){
                //     // console.log(data.toString())
                //     compaign=JSON.parse(data.toString())
                //     console.log(compaign.map)
                //     field=new BuildField(compaign.map)
                //     scene.add(field)
                // })
                compaign = JSON.parse(fs.readFileSync('story/train.json'))
                console.log(compaign)
                
                // build map --------------               
                // field=new BuildField(map=new EmptyMap(21,12))
                field=new BuildField(compaign.map)
                scene.add(field)
                
                // add characters
                // for(var i=1;i<20;i++){
                //     peoples.push(new Character('b',{x:i,y: 0,z:0,d:2},'Recruit-B'))
                // }  
                compaign.cha.forEach(function(doll){
                    var cha=new Character(doll.name,doll.coor,doll.carr)
                    peoples.push(cha)
                    scene.add(cha)
                })
                // peoples.push(new Character(compaign.cha[0].name,compaign.cha[0].coor,compaign.cha[0].carr))
                
                // peoples.push(new Character('B-f1',{x:15,y: 0,z: 3,d:-1},'Recruit-B'))
                // peoples.push(new Character('B-f2',{x:15,y: 0,z: 5,d:-1},'Recruit-B'))
                // peoples.push(new Character('B-f3',{x:15,y: 0,z: 7,d:-1},'Recruit-B'))
                // peoples.push(new Character('W-f1',{x: 5,y: 0,z: 3,d: 1},'Recruit-W'))
                // peoples.push(new Character('W-f2',{x: 5,y: 0,z: 5,d: 1},'Recruit-W'))
                // peoples.push(new Character('W-f3',{x: 5,y: 0,z: 7,d: 1},'Recruit-W'))
                // peoples.push(new Character('a',{x:10,y:.5,z:11,d: 2},'Admiral'))
                // // peoples[0].rotation.y=Math.PI/2
                // peoples.forEach(function(unit){
                //     scene.add(unit)
                // })
                // add objects
                compaign.obj.forEach(function(toy){
                    var obj=new Accessory(toy.name,toy.coor,toy.type)
                    things.push(obj)
                    scene.add(obj)
                })
                // things.push(new Accessory('t1',{x: 0,y: 0,z: 0,d: 1},'torch'))
                // things.push(new Accessory('t2',{x: 0,y: 0,z:11,d: 1},'torch'))
                // things.push(new Accessory('t3',{x:20,y: 0,z: 0,d: 1},'torch'))
                // things.push(new Accessory('t4',{x:20,y: 0,z:11,d: 1},'torch'))
                // things.push(new Accessory('f1',{x: 4,y: 0,z: 5,d: 1},'flag-T'))
                // things.push(new Accessory('f2',{x:16,y: 0,z: 5,d: 1},'flag-D'))
                // things.push(new Accessory('p1',{x:10,y: 0,z:11,d: 1},'Parade1'))
                // things.push(new Accessory('d1',{x: 5,y: 0,z:11,d: 1},'drum'))
                // things.push(new Accessory('d2',{x:15,y: 0,z:11,d: 1},'drum'))
                // things.push(new Accessory('s1',{x: 0,y: 0,z: 0,d: 1},'posiSele'))
                // things.push(new Accessory('s2',{x: 0,y: 0,z: 0,d: 1},'charSele'))
                // things.push(new Accessory('s3',{x: 0,y: 0,z: 0,d: 1},'objeSele'))
                // things.push(new Accessory('s3',{x: 4,y: 0,z: 3,d: 0},'dummy'))
                // things.forEach(function(unit){
                //     scene.add(unit)
                // })

                // add selectors
                selectors[0]=new Accessory('s0',{x: 0,y: 0,z: 0,d: 1},'posiSele')
                scene.add(selectors[0])
                selectors[1]=new Accessory('s1',{x: 0,y: 0,z: 0,d: 1},'charSele')
                scene.add(selectors[1])
                selectors[2]=new Accessory('s2',{x: 0,y: 0,z: 0,d: 1},'objeSele')
                scene.add(selectors[2])

                var geometry = new THREE.BoxGeometry( .05, 1, .05 );
                var material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
                var cube = new THREE.Mesh( geometry, material );
                var cube1 = new THREE.Mesh( geometry, material );
                cube.position.set(.6,.5,.6)
                scene.add( cube );
                cube1=cube.clone()
                cube1.position.set(.6,.5,.7)
                scene.add( cube1 );

                document.oncontextmenu = new Function("return false;");
                document.getElementById('cont').addEventListener('mousedown',onMouseDrag,false)
                document.getElementById('cont').addEventListener('mousemove',onMouseDrag,false)
                document.getElementById('cont').addEventListener('wheel',onMouseDrag,false)
                window.addEventListener('resize',onWindowResize,false)
                
                document.addEventListener('keypress',onKeyPress,false)
            }

            function onMouseDrag(event){
                if(event.deltaY>0 && camera.position.y<20){
                    camera.position.y+=1
                    camera.position.z-=1
                }
                if(event.deltaY<0 && camera.position.y>2){
                    camera.position.y-=1
                    camera.position.z+=1
                }
                if(event.which==3){
                    camera.position.x+=event.movementX/50
                    camera.position.z+=event.movementY/50
                }
                // raycaster ------------------
                var raycaster = new THREE.Raycaster();
                var mouse = new THREE.Vector2();
                mouse.x = ( event.clientX / (window.innerWidth*.8) ) * 2 - 1;
                mouse.y = - ( event.clientY / (window.innerHeight*.7) ) * 2 + 1;
                raycaster.setFromCamera( mouse, camera );

                var intersects = raycaster.intersectObjects( field.children )
                if(intersects.length==1){
                    selectors[0].position.copy(intersects[0].object.position)
                }
                
                if(event.which==1){
                    if(peoples.findByPosition(selectors[0].position)){
                        focusMan=peoples.findByPosition(selectors[0].position)
                    }
                    if(things.findByPosition(selectors[0].position)){
                        focusObj=things.findByPosition(selectors[0].position)
                    }
                }
            }

            function onWindowResize(){
                camera.aspect=window.innerWidth/window.innerHeight
                camera.updateProjectionMatrix()
                renderer.setSize(window.innerWidth*.8,window.innerHeight*.7)
            }

            function onKeyPress(event){
                // peoples.forEach(function(element) {
                //     if(element.name!="a"){                        
                //         element.doSingleCommand(event.key)
                //     }
                // });
                
                if(!focusMan){return}
                // focusMan.traverseVisible(function(obj){console.log(obj)}) // !! look to all the obj in scene
                focusMan.doSingleCommand(event.key)
            }

            // function selectPeopleByName(name){
            //     peoples.forEach(function(man){
            //         if(man.name==name){return man}
            //     });
            // }

            peoples.findByName=function(name){
                var selectMan
                this.forEach(function(man){
                    if(man.name==name){selectMan=man}
                });
                return selectMan
            }
            peoples.findByPosition=function(position){
                var selectMan
                this.forEach(function(man){
                    if(man.position.equals(position)){selectMan=man}
                });
                return selectMan
            }

            // function selectThings(name){
            //     for(var i=0;i<things.length;i++){
            //         // console.log()
            //         if(things[i].name==name){
            //             return things[i]
            //         }
            //     } 
            // }
            
            things.findByName=function(name){
                var selectObj
                this.forEach(function(obj){
                    if(obj.name==name){selectObj=obj}
                });
                return selectObj
            }

            things.findByPosition=function(position){
                var selectObj
                this.forEach(function(obj){
                    if(obj.position.equals(position)){selectObj=obj}
                });
                return selectObj
            }


			function animate() {				
                var delta = clock.getDelta();
                peoples.forEach(function(element) {
                    if(element.mixer!=undefined){
                        element.mixer.update(delta)
                    }
                });
                requestAnimationFrame( animate );
                // console.log(animate())
				render();                
            }
            
			function render() {        
                renderer.render( scene, camera );
                if(focusMan){
                    selectors[1].position.copy(focusMan.position)  
                }
                if(focusObj){
                    selectors[2].position.copy(focusObj.position)  
                }
                    
                
                
                peoples.forEach(function(element) {
                    if(element.mixer!=undefined){
                        if(!element.control && element.name!="a"){                        
                            element.todo('base')
                        }
                        if(!element.control && element.name=="a"){
                            element.todo('sits')
                        }
                        // if(!element.control && element.name=="W-f1"){
                        //     element.todo('sway')
                        // }
                    }
                });        
            }
            init();
            animate();
            
        </script>
	</body>
</html>
