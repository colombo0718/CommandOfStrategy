<!DOCTYPE html>
<html lang="en">
	<head>
		<title>CommandOfStrategy</title>
        <meta charset="utf-8">
        <link type='text/css' rel='stylesheet' href='./main-cos.css'>
        <base href="app://./" />
               
	</head>

	<body>
        <div id="cont"></div>
        <div id="info" class="ui"><h4>[資訊]</h4>
            <p>== 天 ==</p>
                <p>時辰：卯時<br>天氣：晴朗</p><br>
            <p>== 地 ==</p>
                <p>地形：砂土</p><br>
            <p>== 人 ==</p>
                <p>職業：步卒</p><br>
            <span>
            <p><button>W</button>：前進</p>
            <p><button>D</button>：右轉</p>
            <p><button>A</button>：左轉</p>
            <p><button id='commandButton'>X</button>：攻擊</p><br>
            </span>
            <p>== 物 ==</p><p>品項：火炬</p>
        </div>
        <div id="dial" class="ui"><h4>[對話]</h4>
            <p>主帥：對戰開始</p>
            <p style="position:absolute; bottom:0px; width:100%; font-weight:bold;">
                指令:<input type="text" onkeypress="" id='commandLine'>
                <button>Enter</button>
            </p>
        </div>
        
		<script type="module">
            // three.js module
			import * as THREE from './COS.js/three.js/three.module.js';
			import { MTLLoader } from './COS.js/three.js/MTLLoader.js';
			import { OBJLoader } from './COS.js/three.js/OBJLoader.js';
            import { BVHLoader } from './COS.js/three.js/BVHLoader.js';
            // COS.js module
            import { Character } from './COS.js/Character.js';
            import { Accessory } from './COS.js/Accessory.js';
            import { Territory } from './COS.js/Territory.js';
            import { Compaign } from './COS.js/Compaign.js'; //!!!!!!!!!!!!!!!

            // import config from './test.js'
            // console.log(config)

			var container, renderer;
			// var camera, scene;
            var clock = new THREE.Clock();
            // var peoples=[],things=[],selectors=[]//,marks=[]
            // var map,field
            var commandLine=document.getElementById("commandLine")
            var focusMan,focusObj
            var fs=require('fs')
            // console.log(fs)
            var a,states=''
            var arr= new THREE.Group();

            var epic = new Compaign('train')  //!!!!!!!!!!!!!!!!
            console.log(epic)
            

            document.getElementById("commandButton").addEventListener(
                'click',function(){
                    console.log(this.innerHTML)
                    commandLine.value+=this.innerHTML
                }
            )            

			function init() {
                // renderer
                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth*.8, window.innerHeight*.7);
                container = document.getElementById( 'cont' );
                document.body.appendChild( container );
                container.appendChild( renderer.domElement );

                document.oncontextmenu = new Function("return false;");
                document.getElementById('cont').addEventListener('mousedown',onMouseDrag,false)
                document.getElementById('cont').addEventListener('mousemove',onMouseDrag,false)
                document.getElementById('cont').addEventListener('wheel',onMouseDrag,false)
                window.addEventListener('resize',onWindowResize,false)
                document.addEventListener('keyup',onKeyPress,false)
            }

            function onMouseDrag(event){
                if(event.deltaY>0 && epic.camera.position.y<50){
                    epic.camera.position.y+=1
                    epic.camera.position.z-=1
                }
                if(event.deltaY<0 && epic.camera.position.y>2){
                    epic.camera.position.y-=1
                    epic.camera.position.z+=1
                }
                if(event.which==3){
                    epic.camera.position.x+=event.movementX/50
                    epic.camera.position.z+=event.movementY/50
                }
                // raycaster ------------------
                var raycaster = new THREE.Raycaster();
                var mouse = new THREE.Vector2();
                mouse.x = ( event.clientX / (window.innerWidth*.8) ) * 2 - 1;
                mouse.y = - ( event.clientY / (window.innerHeight*.7) ) * 2 + 1;
                raycaster.setFromCamera( mouse, epic.camera );
                var intersects = raycaster.intersectObjects( epic.terrain.children)
                // console.log(intersects.length)
                if(intersects.length==1){
                    console.log(intersects[0].object.showSeletor(0x000000))
                }
            }

            function onWindowResize(){
                camera.aspect=window.innerWidth/window.innerHeight
                camera.updateProjectionMatrix()
                renderer.setSize(window.innerWidth*.8,window.innerHeight*.7)
            }

            function onKeyPress(event){
                var operators
                if(focusMan){
                    operators=focusMan.doSingleCommand(event.key)
                }
                if(operators){
                    operators.forEach(function(oper){
                        peoples.forEach(function(man){
                            if(man.position.equals(oper.position)){
                                man.health-=oper.damage
                                man.todo('beaten',1)
                            }
                        })
                    })
                }
                states=''
                peoples.forEach(function(man){
                    states+=man.getStates()
                })
                console.log(states)
            }

			function animate() {				
                var delta = clock.getDelta();            
                epic.peoples.children.forEach(function(element) {
                    if(element.mixer!=undefined){
                        element.mixer.update(delta)
                    }
                });
                renderer.render( epic, epic.camera );
                requestAnimationFrame( animate );  
                
                // console.log(epic.terrain.children[0])
            }

            init();
            animate();
            
        </script>
	</body>
</html>
