<!DOCTYPE html>
<html lang="en">
	<head>
		<title>CommandOfStrategy</title>
        <meta charset="utf-8">
        <link type='text/css' rel='stylesheet' href='./main-cos.css'>
        <base href="app://./" />
               
	</head>

	<body>
        <div id="cont"></div>
        <div id="info" class="ui"><h4>[資訊]</h4>
            <p>== 天 ==</p>
                <p>時辰：卯時<br>天氣：晴朗</p><br>
            <p>== 地 ==</p>
                <p>地形：砂土</p><br>
            <p>== 人 ==</p>
                <p>職業：步卒</p><br>
            <span>
            <p><button>W</button>：前進</p>
            <p><button>D</button>：右轉</p>
            <p><button>A</button>：左轉</p>
            <p><button id='commandButton'>X</button>：攻擊</p><br>
            </span>
            <p>== 物 ==</p><p>品項：火炬</p>
        </div>
        <div id="dial" class="ui"><h4>[對話]</h4>
            <p>主帥：對戰開始</p>
            <p style="position:absolute; bottom:0px; width:100%; font-weight:bold;">
                指令:<input type="text" onkeypress="" id='commandLine'>
                <button>Enter</button>
            </p>
        </div>
        <!-- <script src="https://code.jquery.com/jquery-3.4.1.js"></script>  -->
		<script type="module">
            // three.js module
			import * as THREE from './COS.js/three.js/three.module.js';
			import { MTLLoader } from './COS.js/three.js/MTLLoader.js';
			import { OBJLoader } from './COS.js/three.js/OBJLoader.js';
            import { BVHLoader } from './COS.js/three.js/BVHLoader.js';
            // COS.js module
            import { Character } from './COS.js/Character.js';
            import { Accessory } from './COS.js/Accessory.js';
            import { EmptyMap,BuildField } from './COS.js/BattleField.js';
            // import config from './test.js'
            // console.log(config)

			var container;
			var camera, scene, renderer;
            var clock = new THREE.Clock();
            var peoples=[],things=[],selectors=[]//,marks=[]
            var map,field
            var commandLine=document.getElementById("commandLine")
            var focusMan,focusObj
            var fs=require('fs')
            // console.log(fs)
            var a,states=''
            var arr= new THREE.Group();
            

            document.getElementById("commandButton").addEventListener(
                'click',function(){
                    console.log(this.innerHTML)
                    commandLine.value+=this.innerHTML
                }
            )            

			function init() {
                // renderer
                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth*.8, window.innerHeight*.7);
                container = document.getElementById( 'cont' );
                document.body.appendChild( container );
                container.appendChild( renderer.domElement );

				// scene
                scene = new THREE.Scene();

                // camera
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight,0.1, 2000 );
                camera.position.set(10,20,-20)
                camera.rotateY(-Math.PI)
                camera.rotateX(-2*Math.PI/8)
                scene.add( camera );
                
                // lights
				var ambientLight = new THREE.AmbientLight( 0xcccccc, 1);
				scene.add( ambientLight );
                
				// var pointLight = new THREE.PointLight( 0xffffff, .3 );
                // scene.add( pointLight );
                // pointLight.position.set(5,5,5)

                // try fs load json --------------
                var compaign
                compaign = JSON.parse(fs.readFileSync('story/train.json'))
                // compaign = JSON.parse(fs.readFileSync('story/basic.json'))
                // build field --------------       
                // field=new BuildField(a=new EmptyMap(50,50))
                field=new BuildField(compaign.map)
                scene.add(field)
                
                // add characters from document
                compaign.cha.forEach(function(doll){
                    var cha=new Character(doll.name,doll.position,doll.carr,doll.camp)
                    cha.showMarks()
                    peoples.push(cha)
                    scene.add(cha)
                    scene.add(cha.markSpace)
                })
    
                // add objects from document
                compaign.obj.forEach(function(toy){
                    var obj=new Accessory(toy.name,toy.position,toy.type)
                    things.push(obj)
                    scene.add(obj)
                }) 
                
                // add arrow test
                    // arr=things.findByName('a1')
                    // arr.scale.set(.125,.125,.125)

                // add selectors
                selectors[0]=new Accessory('s0',{x: 0,y: 0,z: 0,d: 1},'posiSele')
                scene.add(selectors[0])
                selectors[1]=new Accessory('s1',{x: 0,y: 0,z: 0,d: 1},'charSele')
                scene.add(selectors[1])
                selectors[2]=new Accessory('s2',{x: 0,y: 0,z: 0,d: 1},'objeSele')
                scene.add(selectors[2])
                
                // user control react
                document.oncontextmenu = new Function("return false;");
                document.getElementById('cont').addEventListener('mousedown',onMouseDrag,false)
                document.getElementById('cont').addEventListener('mousemove',onMouseDrag,false)
                document.getElementById('cont').addEventListener('wheel',onMouseDrag,false)
                window.addEventListener('resize',onWindowResize,false)
                
                document.addEventListener('keyup',onKeyPress,false)
            }

            function onMouseDrag(event){
                if(event.deltaY>0 && camera.position.y<50){
                    camera.position.y+=1
                    camera.position.z-=1
                }
                if(event.deltaY<0 && camera.position.y>2){
                    camera.position.y-=1
                    camera.position.z+=1
                }
                if(event.which==3){
                    camera.position.x+=event.movementX/50
                    camera.position.z+=event.movementY/50
                }
                // raycaster ------------------
                var raycaster = new THREE.Raycaster();
                var mouse = new THREE.Vector2();
                mouse.x = ( event.clientX / (window.innerWidth*.8) ) * 2 - 1;
                mouse.y = - ( event.clientY / (window.innerHeight*.7) ) * 2 + 1;
                raycaster.setFromCamera( mouse, camera );

                var intersects = raycaster.intersectObjects( field.children )
                if(intersects.length==1){
                    selectors[0].position.copy(intersects[0].object.position)
                }
                
                if(event.which==1){
                    if(peoples.findByPosition(selectors[0].position)){
                        focusMan=peoples.findByPosition(selectors[0].position)
                    }
                    if(things.findByPosition(selectors[0].position)){
                        focusObj=things.findByPosition(selectors[0].position)
                    }
                }
            }

            function onWindowResize(){
                camera.aspect=window.innerWidth/window.innerHeight
                camera.updateProjectionMatrix()
                renderer.setSize(window.innerWidth*.8,window.innerHeight*.7)
            }

            function onKeyPress(event){
                var a
                if(focusMan){
                    a=focusMan.doSingleCommand(event.key)
                }
                if(a){
                    a.forEach(function(oper){
                        peoples.forEach(function(man){
                            if(man.position.equals(oper.position)){
                                man.health-=oper.damage
                                console.log(man.health)
                                man.todo('beaten',1)
                            }
                        })
                    })
                }
                states=''
                peoples.forEach(function(man){
                    // states+=man.name+''+man.position.x+''+man.position.y+''+man.position.z+''+man.position.d
                    states+=man.position.d
                })
                console.log(states)

                if(event.key=='p'){
                    arr.position.set(3,.5,0)
                }
            }


            peoples.findByName=function(name){
                var selectMan
                this.forEach(function(man){
                    if(man.name==name){selectMan=man}
                });
                return selectMan
            }
            peoples.findByPosition=function(position){
                var selectMan
                this.forEach(function(man){
                    if(man.position.equals(position)){selectMan=man}
                });
                return selectMan
            }
            
            things.findByName=function(name){
                var selectObj
                this.forEach(function(obj){
                    if(obj.name==name){selectObj=obj}
                });
                return selectObj
            }

            things.findByPosition=function(position){
                var selectObj
                this.forEach(function(obj){
                    if(obj.position.equals(position)){selectObj=obj}
                });
                return selectObj
            }

			function animate() {				
                var delta = clock.getDelta();
                peoples.forEach(function(element) {
                    if(element.mixer!=undefined){
                        element.mixer.update(delta)
                    }
                });
                // console.log(peoples[0].mixer.update(delta))
                // if(arr.mixer!=undefined){
                //     arr.mixer.update(delta)
                // }
                var v=10
                if(Math.abs(arr.position.z-5)<.1){
                    arr.position.z+=0
                }else{arr.position.z+=v*delta}
                // arr.position.z+=v*delta
                arr.position.z
                
                requestAnimationFrame( animate );
				render();                
            }
            
			function render() {        
                renderer.render( scene, camera );
                if(focusMan){
                    selectors[1].position.copy(focusMan.position)  
                }
                if(focusObj){
                    selectors[2].position.copy(focusObj.position) 
                }    
            }
            init();
            animate();
            
        </script>
	</body>
</html>
